{
	"name": "offence DataFlow - Agency",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "sourceOffensesFileAgency",
						"type": "DatasetReference"
					},
					"name": "offenceDataSource"
				},
				{
					"dataset": {
						"referenceName": "areaDataSource",
						"type": "DatasetReference"
					},
					"name": "AreaData"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "destinationOffensesData",
						"type": "DatasetReference"
					},
					"name": "updateDatabase"
				}
			],
			"transformations": [
				{
					"name": "RemoveNAData"
				},
				{
					"name": "ConvertDataTypes"
				},
				{
					"name": "AreaTableJoin"
				}
			],
			"script": "parameters{\n\tisReported as integer (1)\n}\nsource(output(\n\t\tProp_0 as string,\n\t\tORI7 as string,\n\t\tYEAR as string,\n\t\t{Available.Datasets} as string,\n\t\tPOP as string,\n\t\tNAME as string,\n\t\tADDRESS_ZIP as string,\n\t\tAGCYTYPE as string,\n\t\tSUBTYPE1 as string,\n\t\tSUBTYPE2 as string,\n\t\tPARTOF as string,\n\t\tU_POPGRP as string,\n\t\tCORE as string,\n\t\tSUB as string,\n\t\tfmsa as string,\n\t\tfmsaname as string,\n\t\tFIPS as string,\n\t\tCOUNTYNAME as string,\n\t\tFSTATE as string,\n\t\tREGION as string,\n\t\tMonths_Reported as string,\n\t\tArrests as string,\n\t\tArrestRate as string,\n\t\tMALE as string,\n\t\tFEMALE as string,\n\t\tAGE_09 as string,\n\t\tM0_9 as string,\n\t\tF0_9 as string,\n\t\tAGE_10_12 as string,\n\t\tM10_12 as string,\n\t\tF10_12 as string,\n\t\tAGE_13_15 as string,\n\t\tM13_15 as string,\n\t\tF13_15 as string,\n\t\tAGE_16_17 as string,\n\t\tM16_17 as string,\n\t\tF16_17 as string,\n\t\tAGE_18_24 as string,\n\t\tM18_24 as string,\n\t\tF18_24 as string,\n\t\tAGE_25_29 as string,\n\t\tM25_29 as string,\n\t\tF25_29 as string,\n\t\tAGE_30_34 as string,\n\t\tM30_34 as string,\n\t\tF30_34 as string,\n\t\tAGE_35_39 as string,\n\t\tM35_39 as string,\n\t\tF35_39 as string,\n\t\tAGE_40_44 as string,\n\t\tM40_44 as string,\n\t\tF40_44 as string,\n\t\tAGE_45_49 as string,\n\t\tM45_49 as string,\n\t\tF45_49 as string,\n\t\tAGE_50_54 as string,\n\t\tM50_54 as string,\n\t\tF50_54 as string,\n\t\tAGE_55_59 as string,\n\t\tM55_59 as string,\n\t\tF55_59 as string,\n\t\tAGE_60_64 as string,\n\t\tM60_64 as string,\n\t\tF60_64 as string,\n\t\tAGE_65OVER as string,\n\t\tM65 as string,\n\t\tF65 as string,\n\t\tRace as string,\n\t\tWHITE as string,\n\t\tJW as string,\n\t\tAW as string,\n\t\tBLACK as string,\n\t\tJB as string,\n\t\tAB as string,\n\t\tASIAN as string,\n\t\tJA as string,\n\t\tAA as string,\n\t\tNATIVE as string,\n\t\tJI as string,\n\t\tAI as string,\n\t\t{Race.PropReported} as string,\n\t\tEthnicity as string,\n\t\tHISPANIC as string,\n\t\tJH as string,\n\t\tAH as string,\n\t\tNON_HISPANIC as string,\n\t\tJN as string,\n\t\tAN as string,\n\t\t{Ethnicity.PropReported} as string,\n\t\tOFFENSE as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> offenceDataSource\nsource(output(\n\t\tAreaId as integer,\n\t\tAreaTypeId as integer,\n\t\tRegionId as integer,\n\t\tStateId as integer,\n\t\tFips as integer,\n\t\tAreaName as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> AreaData\noffenceDataSource filter(YEAR != 'NA' && YEAR != 'na' && FIPS != 'NA' && FIPS != 'na' && FSTATE != 'NA' && FSTATE != 'na' && REGION != 'NA' && REGION != 'na') ~> RemoveNAData\nRemoveNAData derive(YEAR = toInteger(YEAR),\n\t\tFIPS = toInteger(FIPS),\n\t\tFSTATE = toInteger(FSTATE),\n\t\tREGION = toInteger(REGION),\n\t\tALLGENDERS = case(lower(Arrests) == 'na', 0, case(toInteger(Arrests) < 0 , -1, toInteger(Arrests))),\n\t\tMALE = case(lower(MALE) == 'na', 0, case(toInteger(MALE) < 0 , -1, toInteger(MALE))),\n\t\tFEMALE = case(lower(FEMALE) == 'na', 0, case(toInteger(FEMALE) < 0 , -1, toInteger(FEMALE))),\n\t\tAllGenders_0_17 = case(lower(AGE_09) == 'na', 0, case(toInteger(AGE_09) < 0 , 0, toInteger(AGE_09))) + \r\ncase(lower(AGE_10_12) == 'na', 0, case(toInteger(AGE_10_12) < 0 , 0, toInteger(AGE_10_12))) + \r\ncase(lower(AGE_13_15) == 'na', 0, case(toInteger(AGE_13_15) < 0 , 0, toInteger(AGE_13_15))) + \r\ncase(lower(AGE_16_17) == 'na', 0, case(toInteger(AGE_16_17) < 0 , 0, toInteger(AGE_16_17))),\n\t\tMale_0_17 = case(lower(M0_9) == 'na', 0, case(toInteger(M0_9) < 0 , 0, toInteger(M0_9))) + \r\ncase(lower(M10_12) == 'na', 0, case(toInteger(M10_12) < 0 , 0, toInteger(M10_12))) + \r\ncase(lower(M13_15) == 'na', 0, case(toInteger(M13_15) < 0 , 0, toInteger(M13_15))) + \r\ncase(lower(M16_17) == 'na', 0, case(toInteger(M16_17) < 0 , 0, toInteger(M16_17))),\n\t\tFemale_0_17 = case(lower(F0_9) == 'na', 0, case(toInteger(F0_9) < 0 , 0, toInteger(F0_9))) + \r\ncase(lower(F10_12) == 'na', 0, case(toInteger(F10_12) < 0 , 0, toInteger(F10_12))) + \r\ncase(lower(F13_15) == 'na', 0, case(toInteger(F13_15) < 0 , 0, toInteger(F13_15))) + \r\ncase(lower(F16_17) == 'na', 0, case(toInteger(F16_17) < 0 , 0, toInteger(F16_17))),\n\t\tAllGenders_18_24 = case(lower(AGE_18_24) == 'na', 0, case(toInteger(AGE_18_24) < 0 , 0, toInteger(AGE_18_24))),\n\t\tMale_18_24 = case(lower(M18_24) == 'na', 0, case(toInteger(M18_24) < 0 , 0, toInteger(M18_24))),\n\t\tFemale_18_24 = case(lower(F18_24) == 'na', 0, case(toInteger(F18_24) < 0 , 0, toInteger(F18_24))),\n\t\tAllGenders_25_39 = case(lower(AGE_25_29) == 'na', 0, case(toInteger(AGE_25_29) < 0 , 0, toInteger(AGE_25_29))) +\ncase(lower(AGE_30_34) == 'na', 0, case(toInteger(AGE_30_34) < 0 , 0, toInteger(AGE_30_34))) +\ncase(lower(AGE_35_39) == 'na', 0, case(toInteger(AGE_35_39) < 0 , 0, toInteger(AGE_35_39))),\n\t\tMale_25_39 = case(lower(M25_29) == 'na', 0, case(toInteger(M25_29) < 0 , 0, toInteger(M25_29))) +\ncase(lower(M30_34) == 'na', 0, case(toInteger(M30_34) < 0 , 0, toInteger(M30_34))) +\ncase(lower(M35_39) == 'na', 0, case(toInteger(M35_39) < 0 , 0, toInteger(M35_39))),\n\t\tFemale_25_39 = case(lower(F25_29) == 'na', 0, case(toInteger(F25_29) < 0 , 0, toInteger(F25_29))) +\ncase(lower(F30_34) == 'na', 0, case(toInteger(F30_34) < 0 , 0, toInteger(F30_34))) +\ncase(lower(F35_39) == 'na', 0, case(toInteger(F35_39) < 0 , 0, toInteger(F35_39))),\n\t\tAllGenders_40_59 = case(lower(AGE_40_44) == 'na', 0, case(toInteger(AGE_40_44) < 0 , 0, toInteger(AGE_40_44))) +\ncase(lower(AGE_45_49) == 'na', 0, case(toInteger(AGE_45_49) < 0 , 0, toInteger(AGE_45_49))) +\ncase(lower(AGE_50_54) == 'na', 0, case(toInteger(AGE_50_54) < 0 , 0, toInteger(AGE_50_54))) +\ncase(lower(AGE_55_59) == 'na', 0, case(toInteger(AGE_55_59) < 0 , 0, toInteger(AGE_55_59))),\n\t\tMale_40_59 = case(lower(M40_44) == 'na', 0, case(toInteger(M40_44) < 0 , 0, toInteger(M40_44))) +\ncase(lower(M45_49) == 'na', 0, case(toInteger(M45_49) < 0 , 0, toInteger(M45_49))) +\ncase(lower(M50_54) == 'na', 0, case(toInteger(M50_54) < 0 , 0, toInteger(M50_54))) +\ncase(lower(M55_59) == 'na', 0, case(toInteger(M55_59) < 0 , 0, toInteger(M55_59))),\n\t\tFemale_40_59 = case(lower(F40_44) == 'na', 0, case(toInteger(F40_44) < 0 , 0, toInteger(F40_44))) +\ncase(lower(F45_49) == 'na', 0, case(toInteger(F45_49) < 0 , 0, toInteger(F45_49))) +\ncase(lower(F50_54) == 'na', 0, case(toInteger(F50_54) < 0 , 0, toInteger(F50_54))) +\ncase(lower(F55_59) == 'na', 0, case(toInteger(F55_59) < 0 , 0, toInteger(F55_59))),\n\t\tAllGenders_60 = case(lower(AGE_60_64) == 'na', 0, case(toInteger(AGE_60_64) < 0 , 0, toInteger(AGE_60_64))) +\ncase(lower(AGE_65OVER) == 'na', 0, case(toInteger(AGE_65OVER) < 0 , 0, toInteger(AGE_65OVER))),\n\t\tMale_60 = case(lower(M60_64) == 'na', 0, case(toInteger(M60_64) < 0 , 0, toInteger(M60_64))) +\ncase(lower(M65) == 'na', 0, case(toInteger(M65) < 0 , 0, toInteger(M65))),\n\t\tFemale_60 = case(lower(F60_64) == 'na', 0, case(toInteger(F60_64) < 0 ,0, toInteger(F60_64))) +\ncase(lower(F65) == 'na', 0, case(toInteger(F65) < 0 , 0, toInteger(F65))),\n\t\tWhiteRace = case(lower(WHITE) == 'na', 0, case(toInteger(WHITE) < 0 , -1, toInteger(WHITE))),\n\t\tWhiteAdult = case(lower(AW) == 'na', 0, case(toInteger(AW) < 0 , -1, toInteger(AW))),\n\t\tWhiteJuvenile = case(lower(JW) == 'na', 0, case(toInteger(JW) < 0 , -1, toInteger(JW))),\n\t\tBlackRace = case(lower(BLACK) == 'na', 0, case(toInteger(BLACK) < 0 , -1, toInteger(BLACK))),\n\t\tBlackAdult = case(lower(AB) == 'na', 0, case(toInteger(AB) < 0 , -1, toInteger(AB))),\n\t\tBlackJuvenile = case(lower(JB) == 'na', 0, case(toInteger(JB) < 0 , -1, toInteger(JB))),\n\t\tAsianEthnicity = case(lower(ASIAN) == 'na', 0, case(toInteger(ASIAN) < 0 , -1, toInteger(ASIAN))),\n\t\tAsianAdult = case(lower(AA) == 'na', 0, case(toInteger(AA) < 0 , -1, toInteger(AA))),\n\t\tAsianJuvenile = case(lower(JA) == 'na', 0, case(toInteger(JA) < 0 , -1, toInteger(JA))),\n\t\tNativeAmerican = case(lower(NATIVE) == 'na', 0, case(toInteger(NATIVE) < 0 , -1, toInteger(NATIVE))),\n\t\tNativeAmericanAdult = case(lower(AN) == 'na', 0, case(toInteger(AN) < 0 , -1, toInteger(AN))),\n\t\tNativeAmericanJuvenile = case(lower(JN) == 'na', 0, case(toInteger(JN) < 0 , -1, toInteger(JN))),\n\t\tHispanicEthnicity = case(lower(HISPANIC) == 'na', 0, case(toInteger(HISPANIC) < 0 , -1, toInteger(HISPANIC))),\n\t\tHispanicAdult = case(lower(AH) == 'na', 0, case(toInteger(AH) < 0 , -1, toInteger(AH))),\n\t\tHispanicJuvenile = case(lower(JH) == 'na', 0, case(toInteger(JH) < 0 , -1, toInteger(JH))),\n\t\tIsReported = $isReported,\n\t\tNonHispanicEthnicity = case(lower(NON_HISPANIC) == 'na', 0, case(toInteger(NON_HISPANIC) < 0 , -1, toInteger(NON_HISPANIC))),\n\t\tNonHispanicAdult = case(lower(AN) == 'na', 0, case(toInteger(AN) < 0 , -1, toInteger(AN))),\n\t\tNonHispanicJuvenile = case(lower(JN) == 'na', 0, case(toInteger(JN) < 0 , -1, toInteger(JN))),\n\t\tTotalPopulation = case(lower(POP) == 'na', 0, case(toInteger(POP) < 0 , -1, toInteger(POP)))) ~> ConvertDataTypes\nConvertDataTypes, AreaData join(FSTATE == AreaTypeId\n\t&& REGION == RegionId\n\t&& ConvertDataTypes@FIPS == AreaData@Fips\n\t&& NAME == upper(AreaName),\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> AreaTableJoin\nAreaTableJoin sink(input(\n\t\tYear as integer,\n\t\tAreaId as integer,\n\t\tAreaTypeId as integer,\n\t\tIsReported as boolean,\n\t\tFips as integer,\n\t\tORI7 as string,\n\t\tAllGenders as integer,\n\t\tMale as integer,\n\t\tFemale as integer,\n\t\tAllGenders_0_17 as integer,\n\t\tMale_0_17 as integer,\n\t\tFemale_0_17 as integer,\n\t\tAllGenders_18_24 as integer,\n\t\tMale_18_24 as integer,\n\t\tFemale_18_24 as integer,\n\t\tAllGenders_25_39 as integer,\n\t\tMale_25_39 as integer,\n\t\tFemale_25_39 as integer,\n\t\tAllGenders_40_59 as integer,\n\t\tMale_40_59 as integer,\n\t\tFemale_40_59 as integer,\n\t\tAllGenders_60 as integer,\n\t\tMale_60 as integer,\n\t\tFemale_60 as integer,\n\t\tWhite as integer,\n\t\tWhiteAdult as integer,\n\t\tWhiteJuvenile as integer,\n\t\tBlack as integer,\n\t\tBlackAdult as integer,\n\t\tBlackJuvenile as integer,\n\t\tAsian as integer,\n\t\tAsianAdult as integer,\n\t\tAsianJuvenile as integer,\n\t\tNativeAmerican as integer,\n\t\tNativeAmericanAdult as integer,\n\t\tNativeAmericanJuvenile as integer,\n\t\tHispanic as integer,\n\t\tHispanicAdult as integer,\n\t\tHispanicJuvenile as integer,\n\t\tNonHispanic as integer,\n\t\tNonHispanicAdult as integer,\n\t\tNonHispanicJuvenile as integer,\n\t\tTotalPopulation as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tmapColumn(\n\t\tYear = YEAR,\n\t\tAreaId,\n\t\tAreaTypeId,\n\t\tIsReported,\n\t\tFips = AreaData@Fips,\n\t\tORI7,\n\t\tAllGenders = ALLGENDERS,\n\t\tMale = MALE,\n\t\tFemale = FEMALE,\n\t\tAllGenders_0_17,\n\t\tMale_0_17,\n\t\tFemale_0_17,\n\t\tAllGenders_18_24,\n\t\tMale_18_24,\n\t\tFemale_18_24,\n\t\tAllGenders_25_39,\n\t\tMale_25_39,\n\t\tFemale_25_39,\n\t\tAllGenders_40_59,\n\t\tMale_40_59,\n\t\tFemale_40_59,\n\t\tAllGenders_60,\n\t\tMale_60,\n\t\tFemale_60,\n\t\tWhite = WhiteRace,\n\t\tWhiteAdult,\n\t\tWhiteJuvenile,\n\t\tBlack = BlackRace,\n\t\tBlackAdult,\n\t\tBlackJuvenile,\n\t\tAsian = AsianEthnicity,\n\t\tAsianAdult,\n\t\tAsianJuvenile,\n\t\tNativeAmerican,\n\t\tNativeAmericanAdult,\n\t\tNativeAmericanJuvenile,\n\t\tHispanic = HispanicEthnicity,\n\t\tHispanicAdult,\n\t\tHispanicJuvenile,\n\t\tNonHispanic = NonHispanicEthnicity,\n\t\tNonHispanicAdult,\n\t\tNonHispanicJuvenile,\n\t\tTotalPopulation\n\t),\n\tskipDuplicateMapInputs: true,\n\terrorHandlingOption: 'stopOnFirstError') ~> updateDatabase"
		}
	}
}